<p id="notice"><%= notice %></p>

<style>
th, td {border: 1px solid black}
table, th, td { border-collapse: collapse }
th {background-color: #f2f2f2}
</style>

<table id="example-table">
  <thead>
    <tr>
      <th align="left" tabulator-field="date">Datum</th>
      <th align="left" tabulator-field="number">Num</th>
      <th align="left" tabulator-field="description" tabulator-editor="input">Beskrivning</th>
      <th align="left" tabulator-field="account">Konto</th>
      <th align="left" tabulator-field="reconciled" tabulator-editor="input">Avstämt</th>
      <th align="left" tabulator-field="increase" tabulator-editor="input">Öka</th>
      <th align="left" tabulator-field="decrease" tabulator-editor="input">Minska</th>
      <th tabulator-field="split_id" tabulator-visible="false">Split id</th>
    </tr>
  </thead>

  <tbody>
    <tr>
      <td><%= @etransaction.date_posted_date %></td>
      <td><%= @etransaction.num %></td>
      <td><%= @etransaction.description %></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>

    <% @etransaction.splits.sort_by{|split| split.id}.each do |split| %>
    <tr>
      <td style="border:none"></td>
      <td></td>
      <td><%= split.memo %></td>
      <td><%= Account.find(split.account_id).full_name %></td>
      <td><%= split.reconciled_state %></td>
      <td><%= if not split.value.nil? and split.value > 0 then split.value end %></td>
      <td><%= if not split.value.nil? and split.value < 0 then -split.value end %></td>
      <td><%= split.id %></td>
    </tr>
    <% end %>
  <tbody>
</table>

<%= link_to 'Edit', edit_etransaction_path(@etransaction) %> |
<%= link_to 'Back', etransactions_path %>

<script>
  var table = new Tabulator("#example-table", {
  columns:[
  {title: "Datum", field: "date", editor: "input"},
  {title: "Konto", field: "account", editor: "autocomplete", editorParams:{
  values: [
  <% Account.all.each do |account| %>
  "<%= account.full_name %>",
  <% end %>
  ]
  }}
  ],
  dataEdited:function(data){
  var url = "<%= update_data_etransaction_url(@etransaction) %>";
  var ajaxData = "data="+JSON.stringify(data);
  $.ajax({ url: url,
  type: 'POST',
  beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
  data: ajaxData,
  success: function(response) {
    $('#notice').html(response);
  }
  });
  },
  dataEdited2:function(data){
  //data - the updated table data
  alert("Data edited");
  var url = "<%= update_data_etransaction_url(@etransaction) %>";
  var xhr = new XMLHttpRequest();
  xhr.open("POST", url, true);
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.send(JSON.stringify(data));  }
  });
</script>

